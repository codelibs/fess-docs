====================
システム関連の設定
====================

概要
====

本セクションでは、|Fess| のシステムレベルの設定について説明します。
ポート番号、メモリ割り当て、ログ設定など、システム全体に影響する重要な設定を取り扱います。

使用ポートの設定
================

デフォルトポート
----------------

|Fess| はデフォルトでポート 8080 を使用します。
このポートで管理画面および検索画面にアクセスできます。

ポート番号の変更
----------------

Linux環境での設定
~~~~~~~~~~~~~~~~~

Linux 環境でポート番号を変更する場合は、``bin/fess.in.sh`` を編集します。

::

    FESS_JAVA_OPTS="$FESS_JAVA_OPTS -Dfess.port=8080"

例えば、ポート 80 を使用する場合:

::

    FESS_JAVA_OPTS="$FESS_JAVA_OPTS -Dfess.port=80"

.. note::
   1024 以下のポート番号を使用する場合は、root 権限または適切な権限設定が必要です。

Windows環境での設定
~~~~~~~~~~~~~~~~~~~

Windows 環境では、``bin\fess.in.bat`` を編集します。

::

    set FESS_JAVA_OPTS=%FESS_JAVA_OPTS% -Dfess.port=8080

Windowsサービスとして登録する場合
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Windows 環境でサービス登録して使用する場合は、``bin\service.bat`` のポート設定も変更してください。

::

    set FESS_PARAMS=-Dfess;-Dfess.home="%FESS_HOME%";-Dfess.es.dir="%SEARCH_ENGINE_HOME%";-Dfess.home="%FESS_HOME%";-Dfess.context.path="/";-Dfess.port=8080;-Dfess.webapp.path="%FESS_HOME%\app";-Dfess.temp.path="%FESS_HOME%\temp";-Dfess.log.name="%APP_NAME%";-Dfess.log.path="%FESS_HOME%\logs";-Dfess.log.level=warn;-Dlasta.env=web;-Dtomcat.config.path=tomcat_config.properties

詳細は :doc:`windows-service` を参照してください。

メモリ設定
==========

概要
----

Java アプリケーションでは、プロセスごとに使用する最大ヒープメモリを設定する必要があります。
|Fess| では、以下の3つのコンポーネントでそれぞれメモリ設定を行います。

- Fess ウェブアプリケーション
- クローラープロセス
- OpenSearch

適切なメモリ設定を行うことで、パフォーマンスの向上と安定した動作を実現できます。

Fess ウェブアプリケーションのメモリ設定
--------------------------------------

設定が必要な場合
~~~~~~~~~~~~~~~~

以下のような場合にメモリサイズの調整を検討してください。

- ``fess.log`` に OutOfMemory エラーが記録される
- 大量の同時アクセスを処理する必要がある
- 管理画面の操作が遅い、またはタイムアウトする

デフォルトのメモリサイズは、一般的な利用では十分ですが、負荷が高い環境では増量が必要です。

環境変数による設定
~~~~~~~~~~~~~~~~~~

環境変数 ``FESS_HEAP_SIZE`` を設定します。

::

    export FESS_HEAP_SIZE=2g

単位:
- ``m``: メガバイト
- ``g``: ギガバイト

RPM/DEBパッケージの場合
~~~~~~~~~~~~~~~~~~~~~~~~

RPMパッケージでインストールした場合は、``/etc/sysconfig/fess`` を編集します。

::

    FESS_HEAP_SIZE=2g

DEBパッケージの場合は、``/etc/default/fess`` を編集します。

::

    FESS_HEAP_SIZE=2g

.. warning::
   メモリサイズを変更した後は、|Fess| サービスを再起動する必要があります。

推奨メモリサイズ
~~~~~~~~~~~~~~~~

.. list-table::
   :header-rows: 1
   :widths: 30 30 40

   * - 環境
     - 推奨ヒープサイズ
     - 備考
   * - 開発・テスト環境
     - 512m〜1g
     - 小規模なインデックス
   * - 小規模本番環境
     - 1g〜2g
     - 数万〜数十万ドキュメント
   * - 中規模本番環境
     - 2g〜4g
     - 数十万〜数百万ドキュメント
   * - 大規模本番環境
     - 4g〜8g
     - 数百万以上のドキュメント

クローラーのメモリ設定
----------------------

設定が必要な場合
~~~~~~~~~~~~~~~~

以下のような場合にクローラーのメモリサイズを増やす必要があります。

- 並列クロール数を増やす場合
- 大きなファイルをクロールする場合
- クロール実行中に OutOfMemory エラーが発生する場合

設定方法
~~~~~~~~

``app/WEB-INF/classes/fess_config.properties`` または ``/etc/fess/fess_config.properties`` を編集します。

::

    jvm.crawler.options=-Xmx512m

例えば、1GB に変更する場合:

::

    jvm.crawler.options=-Xmx1g

.. note::
   この設定は、クローラープロセス単位(スケジューラーのジョブ単位)で適用されます。
   複数のクロールジョブを同時に実行する場合は、それぞれのジョブで指定したメモリが使用されます。

推奨設定
~~~~~~~~

- **通常のWebクロール**: 512m〜1g
- **大量並列クロール**: 1g〜2g
- **大きなファイルのクロール**: 2g〜4g

OpenSearch のメモリ設定
-----------------------

重要な考慮事項
~~~~~~~~~~~~~~

OpenSearch では、以下の2点を考慮してメモリを設定する必要があります。

1. **Javaヒープメモリ**: OpenSearch のプロセスで使用
2. **OSファイルシステムキャッシュ**: 検索パフォーマンスに重要

.. warning::
   Javaヒープメモリを大きくしすぎると、OSファイルシステムキャッシュに
   使用できるメモリが減少し、検索パフォーマンスが低下します。

設定方法
~~~~~~~~

OpenSearch のヒープメモリは、OpenSearch の設定ファイルで指定します。
|Fess| に同梱されている OpenSearch の場合、以下のファイルを編集します。

**Linux:**

環境変数で設定:

::

    export OPENSEARCH_HEAP_SIZE=2g

または、``config/jvm.options`` を編集:

::

    -Xms2g
    -Xmx2g

.. note::
   最小ヒープサイズ(``-Xms``)と最大ヒープサイズ(``-Xmx``)は同じ値に設定することを推奨します。

推奨メモリサイズ
~~~~~~~~~~~~~~~~

.. list-table::
   :header-rows: 1
   :widths: 30 30 40

   * - インデックスサイズ
     - 推奨ヒープサイズ
     - 推奨合計メモリ
   * - 〜10GB
     - 2g
     - 4GB以上
   * - 10GB〜50GB
     - 4g
     - 8GB以上
   * - 50GB〜100GB
     - 8g
     - 16GB以上
   * - 100GB以上
     - 16g〜31g
     - 32GB以上

.. warning::
   OpenSearch のヒープメモリは 32GB を超えないように設定してください。
   32GB を超えると、Compressed OOP が無効になりメモリ効率が低下します。

ベストプラクティス
~~~~~~~~~~~~~~~~~~

1. **物理メモリの50%をヒープに割り当て**

   サーバーの物理メモリの約50%を OpenSearch のヒープに割り当てます。
   残りはOSとファイルシステムキャッシュに使用されます。

2. **最大31GBまで**

   ヒープサイズは最大31GBまでとし、それ以上必要な場合はノードを増やします。

3. **本番環境での確認**

   OpenSearch の公式ドキュメントを参照し、環境に応じた最適な設定を行ってください。

参考リンク
~~~~~~~~~~

詳細は OpenSearch の公式ドキュメントを参照してください。

- `OpenSearch Memory Settings <https://opensearch.org/docs/latest/install-and-configure/install-opensearch/index/#important-settings>`_

ログ設定
========

概要
----

|Fess| は、システムの動作状況やエラー情報を記録するため、複数のログファイルを出力します。
適切なログ設定により、トラブルシューティングやシステム監視が容易になります。

ログファイルの種類
------------------

|Fess| が出力する主要なログファイルは以下の通りです。

.. list-table:: ログファイル一覧
   :header-rows: 1
   :widths: 25 75

   * - ファイル名
     - 内容
   * - ``fess.log``
     - 管理画面や検索画面での操作ログ、アプリケーションエラー、システムイベント
   * - ``fess_crawler.log``
     - クロール実行時のログ、クロール対象URL、取得したドキュメント情報、エラー
   * - ``fess_suggest.log``
     - サジェスト(検索候補)生成時のログ、インデックス更新情報
   * - ``server_?.log``
     - Tomcatなどのアプリケーションサーバーのシステムログ
   * - ``audit.log``
     - ユーザー認証、ログイン/ログアウト、重要な操作の監査ログ

ログファイルの場所
------------------

**Zipインストールの場合:**

::

    {FESS_HOME}/logs/

**RPM/DEBパッケージの場合:**

::

    /var/log/fess/

トラブルシューティング時のログ確認
----------------------------------

問題が発生した場合、以下の手順でログを確認してください。

1. **エラーの種類を特定**

   - アプリケーションエラー → ``fess.log``
   - クロールエラー → ``fess_crawler.log``
   - 認証エラー → ``audit.log``
   - サーバーエラー → ``server_?.log``

2. **最新のエラーを確認**

   ::

       tail -f /var/log/fess/fess.log

3. **特定のエラーを検索**

   ::

       grep -i "error" /var/log/fess/fess.log
       grep -i "exception" /var/log/fess/fess.log

ログレベルの設定
----------------

ログレベルとは
~~~~~~~~~~~~~~

ログレベルは、出力するログの詳細度を制御します。

.. list-table::
   :header-rows: 1
   :widths: 20 80

   * - レベル
     - 説明
   * - ``FATAL``
     - 致命的なエラー(アプリケーションが継続できない)
   * - ``ERROR``
     - エラー(機能の一部が動作しない)
   * - ``WARN``
     - 警告(潜在的な問題)
   * - ``INFO``
     - 情報(重要なイベント)
   * - ``DEBUG``
     - デバッグ情報(詳細な動作ログ)
   * - ``TRACE``
     - トレース情報(最も詳細)

管理画面からの変更
~~~~~~~~~~~~~~~~~~

1. 管理画面にログインします。
2. 「システム」メニューから「全般」を選択します。
3. 「ログレベル」で希望するレベルを選択します。
4. 「更新」ボタンをクリックします。

.. note::
   管理画面での変更は |Fess| の再起動後も保持されます。

設定ファイルによる変更
~~~~~~~~~~~~~~~~~~~~~~

より詳細なログ設定を行う場合は、Log4j2の設定ファイルを編集します。

**設定ファイルの場所:**

- Zipインストール: ``app/WEB-INF/classes/log4j2.xml``
- RPM/DEBパッケージ: ``/etc/fess/log4j2.xml``

**デフォルトのログレベル:**

::

    <Logger name="org.codelibs.fess" level="warn"/>

**例: DEBUGレベルに変更**

::

    <Logger name="org.codelibs.fess" level="debug"/>

**例: 特定のパッケージのログレベル変更**

::

    <Logger name="org.codelibs.fess.crawler" level="info"/>
    <Logger name="org.codelibs.fess.ds" level="debug"/>

.. warning::
   ``DEBUG`` や ``TRACE`` レベルは大量のログを出力するため、
   本番環境では使用しないでください。ディスク容量とパフォーマンスに影響します。

クローラーログの設定
--------------------

クローラーログはデフォルトで ``INFO`` レベルで出力されます。

管理画面での設定
~~~~~~~~~~~~~~~~

1. 管理画面の「クローラー」メニューから対象のクロール設定を開きます。
2. 「設定」タブで「スクリプト」を選択します。
3. スクリプト欄に以下を追加します。

::

    logLevel("DEBUG")

設定可能な値:
- ``FATAL``
- ``ERROR``
- ``WARN``
- ``INFO``
- ``DEBUG``
- ``TRACE``

ログローテーション
------------------

概要
~~~~

ログファイルは時間とともに肥大化するため、定期的なローテーション(世代管理)が必要です。

Log4j2による自動ローテーション
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

|Fess| では、Log4j2のRollingFileAppenderを使用して自動的にログローテーションを行います。

**デフォルトの設定:**

- ファイルサイズ: 10MB を超えたらローテーション
- 保持世代数: 最大10ファイル

設定ファイルの例(``log4j2.xml``):

::

    <RollingFile name="FessFile"
                 fileName="${log.dir}/fess.log"
                 filePattern="${log.dir}/fess.log.%i">
        <PatternLayout pattern="%d{ISO8601} [%t] %-5p %c - %m%n"/>
        <Policies>
            <SizeBasedTriggeringPolicy size="10MB"/>
        </Policies>
        <DefaultRolloverStrategy max="10"/>
    </RollingFile>

logrotateによるローテーション
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Linux環境では、logrotateを使用してログローテーションを管理することもできます。

``/etc/logrotate.d/fess`` の例:

::

    /var/log/fess/*.log {
        daily
        rotate 14
        compress
        delaycompress
        missingok
        notifempty
        create 0644 fess fess
        sharedscripts
        postrotate
            systemctl reload fess > /dev/null 2>&1 || true
        endscript
    }

ログ監視
--------

本番環境では、ログファイルを監視してエラーを早期に検知することを推奨します。

監視すべきログパターン
~~~~~~~~~~~~~~~~~~~~~~

- ``ERROR``、``FATAL`` レベルのログ
- ``OutOfMemoryError``
- ``Connection refused``
- ``Timeout``
- ``Exception``

監視ツールの例
~~~~~~~~~~~~~~

- **Logwatch**: ログファイルの定期的な分析とレポート
- **Logstash + Elasticsearch + Kibana (ELK Stack)**: リアルタイムログ分析
- **Fluentd**: ログ収集・転送
- **Prometheus + Grafana**: メトリクス監視とアラート

パフォーマンスへの影響
----------------------

ログ出力は、ディスクI/Oとパフォーマンスに影響します。

ベストプラクティス
~~~~~~~~~~~~~~~~~~

1. **本番環境ではWARNレベル以上を使用**

   不要な詳細ログを出力しないようにします。

2. **ログファイルの定期的なクリーンアップ**

   古いログファイルを削除または圧縮します。

3. **非同期ログ出力の使用**

   Log4j2の非同期アペンダーを使用して、ログ出力のオーバーヘッドを削減します。

4. **適切なディスク容量の確保**

   ログファイル用に十分なディスク容量を確保します。

トラブルシューティング
----------------------

ログが出力されない
~~~~~~~~~~~~~~~~~~

1. ログディレクトリの権限を確認してください。
2. ディスク容量が十分か確認してください。
3. Log4j2の設定ファイルが正しいか確認してください。

ログファイルが大きくなりすぎる
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. ログレベルを ``WARN`` 以上に設定してください。
2. ログローテーションの設定を確認してください。
3. 不要なログ出力を無効化してください。

特定のログが見つからない
~~~~~~~~~~~~~~~~~~~~~~~~

1. ログレベルが適切か確認してください(低すぎると出力されない)。
2. ログファイルのパスが正しいか確認してください。
3. タイムスタンプを確認し、正しい時間帯を探してください。
